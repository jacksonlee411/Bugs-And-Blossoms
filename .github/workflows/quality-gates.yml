name: Quality Gates

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  code-quality-formatting:
    name: Code Quality & Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - id: paths
        name: Paths Filter
        run: ./scripts/ci/paths-filter.sh
      - uses: actions/setup-go@v5
        if: steps.paths.outputs.go == 'true' || steps.paths.outputs.db == 'true' || steps.paths.outputs.sqlc == 'true' || steps.paths.outputs.authz == 'true'
        with:
          go-version-file: go.mod
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        if: steps.paths.outputs.ui == 'true'
        with:
          node-version: "20"
      - name: Naming Gate (always)
        run: make check naming
      - name: No-Legacy Gate (always)
        run: make check no-legacy
      - name: Docs Gate (always)
        run: make check doc
      - name: UI Build (Astro Shell)
        if: steps.paths.outputs.ui == 'true'
        run: make css
      - name: Go Lint/Fmt Gate
        if: steps.paths.outputs.go == 'true'
        run: |
          make check fmt
          make check lint
      - name: SQLC Generate
        if: steps.paths.outputs.sqlc == 'true'
        run: make sqlc-generate
      - name: Authz Gates
        if: steps.paths.outputs.authz == 'true'
        run: |
          make authz-pack
          make authz-test
          make authz-lint
      - name: Generated Artifacts Clean
        run: ./scripts/ci/assert-clean.sh

  unit-integration-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: bugs_and_blossoms
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U app -d bugs_and_blossoms"
          --health-interval 2s
          --health-timeout 2s
          --health-retries 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - id: paths
        name: Paths Filter
        run: ./scripts/ci/paths-filter.sh
      - uses: actions/setup-go@v5
        if: steps.paths.outputs.go == 'true' || steps.paths.outputs.db == 'true' || steps.paths.outputs.sqlc == 'true' || steps.paths.outputs.authz == 'true' || steps.paths.outputs.routing == 'true'
        with:
          go-version-file: go.mod
      - name: DB Gates (iam)
        if: steps.paths.outputs.db == 'true'
        env:
          DB_HOST: localhost
          DB_PORT: "5432"
          DB_USER: app
          DB_PASSWORD: app
          DB_NAME: bugs_and_blossoms
          DB_SSLMODE: disable
        run: |
          make iam plan
          make iam lint
          make iam migrate up
          make orgunit plan
          make orgunit lint
          make orgunit migrate up
          make jobcatalog plan
          make jobcatalog lint
          make jobcatalog migrate up
          make person plan
          make person lint
          make person migrate up
          make staffing plan
          make staffing lint
          make staffing migrate up
      - name: Run tests
        run: |
          if [[ "${{ steps.paths.outputs.go }}" == "true" || "${{ steps.paths.outputs.db }}" == "true" || "${{ steps.paths.outputs.sqlc }}" == "true" || "${{ steps.paths.outputs.authz }}" == "true" || "${{ steps.paths.outputs.routing }}" == "true" ]]; then
            make test
          else
            echo "no relevant changes; no-op"
          fi

  routing-gates:
    name: Routing Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - id: paths
        name: Paths Filter
        run: ./scripts/ci/paths-filter.sh
      - uses: actions/setup-go@v5
        if: steps.paths.outputs.routing == 'true' || steps.paths.outputs.go == 'true'
        with:
          go-version-file: go.mod
      - name: Run routing gates
        run: |
          if [[ "${{ steps.paths.outputs.routing }}" == "true" || "${{ steps.paths.outputs.go }}" == "true" ]]; then
            make check routing
          else
            echo "no relevant changes; no-op"
          fi

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - id: paths
        name: Paths Filter
        run: ./scripts/ci/paths-filter.sh
      - uses: actions/setup-go@v5
        if: steps.paths.outputs.e2e == 'true' || steps.paths.outputs.ui == 'true' || steps.paths.outputs.i18n == 'true' || steps.paths.outputs.go == 'true' || steps.paths.outputs.routing == 'true'
        with:
          go-version-file: go.mod
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        if: steps.paths.outputs.e2e == 'true' || steps.paths.outputs.ui == 'true' || steps.paths.outputs.i18n == 'true' || steps.paths.outputs.go == 'true' || steps.paths.outputs.routing == 'true'
        with:
          node-version: "20"
      - name: Run E2E
        run: |
          if [[ "${{ steps.paths.outputs.e2e }}" == "true" || "${{ steps.paths.outputs.ui }}" == "true" || "${{ steps.paths.outputs.i18n }}" == "true" || "${{ steps.paths.outputs.go }}" == "true" || "${{ steps.paths.outputs.routing }}" == "true" ]]; then
            make e2e
          else
            echo "no relevant changes; no-op"
          fi
      - name: Upload E2E artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: e2e-artifacts
          if-no-files-found: ignore
          path: |
            e2e/test-results/**
            e2e/playwright-report/**
