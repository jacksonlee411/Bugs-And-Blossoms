# DEV-PLAN-081：OrgUnit Details 记录版本选择器双栏化（左生效日期 / 右详情）

**状态**: 已完成（2026-02-10 11:37 UTC）

## 1. 背景与问题
- 参考画布：`designs/orgunit/orgunit-details-ui.pen` 中 `OrgUnit Details - Records Version Selector`（节点 `00bzg`）。
- 现状中“生效记录”使用“上一条/下一条 + 下拉框”选择版本，而“变更日志”已采用“左侧时间列表 + 右侧详情”双栏结构。
- 两套交互模型并存，导致用户在同一详情页内需要切换心智：
  - 记录版本：先操作导航控件，再在下方区域理解版本内容。
  - 变更日志：直接在左侧选中项，右侧即时查看详情。
- 该不一致增加了学习成本，也降低了“记录版本可浏览、可比对、可回溯”的可发现性。

## 2. 目标与非目标
### 2.1 核心目标
- [X] 将“生效记录”改为与“变更日志”一致的双栏模型：左侧“生效日期列表”，右侧“当前版本详情”。
- [X] 保留现有记录动作语义（新增/插入/修正/状态变更/危险操作），但将操作入口与“当前选中版本”明确绑定。
- [X] 记录动作区遵循“极简优先”：默认仅保留单行入口（主操作 + 次操作 + 更多）。
- [X] 保持 `tree_as_of`（树）与 `effective_date`（详情版本）解耦，不回退到全局 `as_of`。
- [X] 不新增 legacy/双链路；继续走 `/org/api/org-units/details?as_of=...` 的单链路刷新。
- [X] 与 `.pen` 画布在信息分区和主交互上对齐（允许文案微调）。

### 2.2 非目标
- 不新增数据库表、迁移或事件类型。
- 不改动 OrgUnit 写入内核语义（`submit_*_event(...)` 与现有动作保持不变）。
- 不在本计划引入新的全局导航、监控开关或额外模块页面。

## 3. 方案概览（081）
### 3.1 布局重构
将当前 `.org-node-records` 从“按钮区 + 导航条”重构为双栏：
- 左栏（固定宽度，建议 `170~220px`）：
  - 标题：`生效日期`
  - 列表项：`YYYY-MM-DD`（主信息）+ `event_type`（次信息）
  - 不展示操作人姓名/工号，避免时间线噪音
  - 当前选中项高亮（沿用 `#09a7a3` 语义）
- 右栏（自适应）：
  - 顶部先显示“单行动作条”（`新建版本`、`修正当前`、`更多`）
  - 再展示版本详情卡（状态、组织名称、组织编码、上级、负责人、业务单元、组织长名称等）

### 3.1A 极简动作条规范（行业对齐）
- 默认只保留 2+1 入口：
  - 主按钮：`新建版本`
  - 次按钮：`修正当前`
  - 溢出按钮：`更多`（承载状态变更、删除记录、删除组织）
- 危险动作不在页面常驻展开，通过 `更多` 进入二次确认流。
- 动作条置于右栏最上方，详情区作为主要视觉焦点。

### 3.2 交互模型
- 顶部采用单行全宽页签：`基本信息` / `变更日志`，与下方内容区共享一体化视觉边界（非按钮态）。
- 初次加载：服务端按既有规则选中版本（`effective_date` 命中优先），左栏对应项高亮，右栏渲染该版本详情。
- 点击左栏某个生效日期：
  1) 若有未保存编辑，先走既有 `confirmDiscard()`。
  2) 调用既有 `loadDetails(org_id, { effectiveDate })`。
  3) 刷新详情面板后，左栏高亮切换到目标日期，右栏内容同步。
- 点击页签切换时：
  - `基本信息`：左侧显示“生效日期”时间轴。
  - `变更日志`：左侧显示“修改时间”时间轴，右侧显示事件详情。
- 变更日志态去掉“默认显示/筛选”提示行，页签下方直接进入双栏内容。
- “上一条/下一条”处理（已定版）：
  - 完全移除，仅保留左栏日期列表点击切换。
  - 原因：减少重复入口，确保“看列表→点目标日期”是唯一心智路径。

### 3.3 与变更日志的一致性边界
- 对齐点：
  - 都是“左列表（时间轴/日期轴）+ 右详情”的两栏浏览模式。
  - 都支持“当前项高亮 + 详情联动”。
- 差异点（有意保留）：
  - 变更日志左栏主轴是 `tx_time`；记录版本左栏主轴是 `effective_date`。
  - 变更日志右栏强调“字段 diff”；记录版本右栏强调“该版本完整快照 + 可执行动作”。

## 4. 接口与实现影响
### 4.1 后端渲染（`internal/server/orgunit_nodes.go`）
- 重构 `renderOrgNodeDetailsWithAudit(...)` 中记录区块：
  - 删除 `.org-node-version-nav` 与下拉选择器 DOM。
  - 将版本切换入口收敛为左栏“日期项列表”。
  - 每个日期项输出 `data-target-date`，复用现有 JS 点击加载逻辑。
- 保留现有 `versions []OrgUnitNodeVersion` 数据来源，不新增 API。
- 保留现有写动作表单字段（`current_effective_date`、`effective_date` 等），仅调整布局与容器层级。

### 4.2 前端脚本（同文件内联 JS）
- 复用现有“版本切换”主流程：`loadDetails(panel.dataset.orgId, { effectiveDate })`。
- 新增记录日期项点击代理（类名建议：`.org-node-record-item`），作为唯一切换入口。
- 移除 `.org-node-version-btn` / `.org-node-version-select` 事件绑定。
- 保留 unsaved-changes 防护、失败回滚（选择器/高亮恢复）逻辑。

### 4.3 样式（`internal/server/assets/app.css`）
- 新增记录双栏样式（建议命名）：
  - `.org-node-record-log`
  - `.org-node-record-log-left`
  - `.org-node-record-items`
  - `.org-node-record-item`
  - `.org-node-record-log-right`
- 尽量复用现有变更日志样式 token，避免重复定义和视觉漂移。

### 4.4 UI 冻结项（081 当前评审结论）
- 动作条必须位于“版本详情”上方。
- 左侧时间线不显示操作人姓名/工号。
- 左侧不再出现“上一条/下一条”按钮。
- 页签提升一级并占满整行；页签下方直接进入内容区。
- `变更日志` 态不保留“默认显示/筛选”整行提示。

## 5. 数据与不变量
- 继续使用 `OrgUnitNodeVersion`：`event_id/event_uuid/effective_date/event_type`。
- 继续遵循 `DEV-PLAN-032` 的日粒度：UI 仅展示 `YYYY-MM-DD` 生效日期。
- 继续遵循 `DEV-PLAN-076`：
  - URL 只承载 `tree_as_of`。
  - 详情版本通过 `effective_date` 驱动局部刷新。
- 继续遵循 `DEV-PLAN-004M1`：不新增 legacy 参数或回退通道。

## 6. 风险与权衡
- 风险 1：版本很多时左栏过长。
  - 缓解：固定高度 + 滚动；首版不引入分页，必要时后续补“加载更多”。
- 风险 2：动作入口过少导致“高级动作”发现性下降。
  - 缓解：`更多` 保持文案可见，并在菜单首屏提供“状态变更”；危险操作保留显式图标/红色语义。
- 风险 3：双栏与编辑态切换叠加导致 DOM 状态复杂。
  - 缓解：不引入第二套状态机，复用现有 `data-mode` 与 `confirmDiscard` 流程。

## 7. 实施步骤
1. [X] 先更新 `.pen` 画布中 `Records Version Selector` 分屏：生效记录改为双栏模型（左日期、右详情+动作）。
   - 2026-02-10：已完成首版与极简收敛版（动作条上置、移除上一条/下一条、时间线移除姓名工号）。
2. [X] 实现服务端 HTML 重构：输出记录日期列表项（可点击）与右侧详情容器。
   - 2026-02-10：`renderOrgNodeDetailsWithAudit` 已改为“全宽页签 + 双态双栏”，移除旧版版本下拉/上一条/下一条。
   - 2026-02-10：记录动作条已上移至详情标题行右侧，并与标题水平对齐。
3. [X] 实现 CSS 双栏布局与选中态样式，对齐变更日志视觉规范。
   - 2026-02-10：`internal/server/assets/app.css` 已新增基本信息态双栏与时间轴样式，页签改为融合式下划线风格。
4. [X] 接入/复用前端交互：点击左栏项切换版本，保持 unsaved 保护与失败回滚。
   - 2026-02-10：新增 `.org-node-record-item` 点击加载；移除 `.org-node-version-btn/.org-node-version-select` 事件绑定；新增“更多”展开逻辑。
5. [X] 补齐本次改造的最小回归测试（单测），并记录当前环境下的验证边界。
   - 2026-02-10：已执行 `GOCACHE=/home/shangmeilin/Bugs-And-Blossoms-wt-dev-a/tmp/go-build-cache go test ./internal/server -run "OrgNode|OrgNodes|RenderOrgNode|SelectOrgNodeVersion" -count=1` 通过，并补充了 081 结构断言（页签/双栏/动作条上移）。
   - 2026-02-10：全量 `go test ./internal/server` 在当前 sandbox 因 `httptest` 监听受限未跑通，保持在 CI/本机开放端口环境补齐。
6. [X] 更新本计划状态与验收勾选，必要时补充 `081` 执行日志。
   - 2026-02-10：已回写方案定版口径、实现进展与测试证据；如后续新增 E2E 覆盖，再按需补充 `docs/dev-records/` 记录。

## 8. 验收标准
- [X] 记录区呈现为“左生效日期 / 右详情”，不再以下拉作为唯一主入口。
- [X] 右侧按钮条位于版本详情上方，且默认仅显示 `新建版本` / `修正当前` / `更多`。
- [X] 左侧不再显示“上一条/下一条”按钮。
- [X] 左侧时间线次级信息不显示姓名/工号，仅显示事件类型。
- [X] 点击 `变更日志` 时，左侧切换为“修改时间”时间轴，不与生效日期时间轴并存。
- [X] 点击左栏任意日期后，右侧详情显示对应版本，且不触发全页刷新。
- [X] 未保存编辑时，版本切换仍会二次确认；取消后保持原选中版本。
- [X] 无权限场景下，右栏动作入口保持禁用与原因提示。
- [X] 不引入 `as_of` 或其他 legacy 参数；URL 仍仅使用 `tree_as_of`。

## 9. 关联与SSOT
- `AGENTS.md`
- `docs/dev-plans/032-effective-date-day-granularity.md`
- `docs/dev-plans/076-orgunit-version-switch-selection-retention.md`
- `docs/dev-plans/080-orgunit-audit-chain-consolidation.md`
- `designs/orgunit/orgunit-details-ui.pen`
