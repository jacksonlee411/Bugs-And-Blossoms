# DEV-PLAN-046：Payroll P0-6——税后发放（仅个税）的 Tax Gross-up（公司承担税金成本）

**状态**: 规划中（2026-01-08 02:40 UTC）

> 上游路线图：`DEV-PLAN-039`  
> 依赖：`DEV-PLAN-044`（累计预扣 IIT 引擎 + balances）  
> 蓝图合同（口径/算法合同）：`DEV-PLAN-040` §5.2.1

## 0. 可执行方案（本计划合同）

### 0.1 背景与上下文

业务要求：工资项可配置“税后到手=指定净额”（仅扣个税后到手），公司承担为实现该净额保证而产生的全部税金成本，并覆盖税上税递归效应。

本切片的关键在于：**确定性求解 + 可审计分摊**，并与累计预扣引擎保持同一舍入合同。

### 0.2 目标与非目标（P0-6 Slice）

**目标**
- [ ] 定义并落地工资项输入：`calc_mode=net_guaranteed_iit` + `target_net` + `tax_bearer=employer`（命名可调整，但语义必须冻结）。
- [ ] 实现 group-level 求解：对同一工资条中所有净额保证项求 `x-ΔIIT(x)=T`（按“分”二分/确定性迭代），覆盖税上税。
- [ ] 分摊合同冻结：将 `ΔIIT(x)` 按 `target_net` 比例分摊到各工资项，确保逐项 `net_after_iit == target_net` 且 `Σ tax_i == ΔIIT(x)`。
- [ ] 工资条可解释：展示 `target_net`、求解后的 `gross_amount` 与本期 `iit_delta`。

**非目标**
- 不覆盖社保/公积金等扣款的“税后净额保证”（口径已在 `DEV-PLAN-040` 冻结：仅个税）。

### 0.3 工具链与门禁（SSOT 引用）

- 触发器矩阵与本地必跑：`AGENTS.md`
- 金额精度与舍入合同：`DEV-PLAN-040` §4.2

### 0.4 关键不变量与失败路径（停止线）

- **确定性求解**：禁止 float；禁止一次近似；必须在“分”粒度内收敛或失败（稳定错误码）。
- **审计可复现**：工资条必须能复算并解释 `gross_amount`、`iit_delta`、分摊结果。
- **显式声明**：仅当 `tax_bearer=employer` 且 `calc_mode=net_guaranteed_iit` 时启用；默认税负仍由员工承担。

### 0.5 实施步骤（Checklist）

1. [ ] 落地输入载体（最小）：HR 可在工资条/批次维度录入一个净额保证工资项（长期服务奖）并关联到具体人员。
2. [ ] 计算：先算 `IIT_base`，再定义 `ΔIIT(x)`，求解 `x-ΔIIT(x)=T`，最后分摊并落明细项。
3. [ ] UI：工资条详情展示该项的 `target_net/gross_amount/iit_delta`，并能看出公司承担税金成本的口径。
4. [ ] 测试：覆盖 1 项与多项净额保证、分摊舍入边界、求解不收敛的失败路径。

### 0.6 验收标准（Done 口径）

- [ ] 在同一工资条中录入“长期服务奖（税后）=20,000.00”，计算后该项 `net_after_iit == 20,000.00`（精确到分）。
- [ ] 工资条可解释展示该项 `gross_amount` 与 `iit_delta`，且公司成本口径包含该税金成本。
