# DEV-PLAN-055：考勤 Slice 4E——纠错与审计闭环（更正事件 + 重算）

**状态**: 草拟中（2026-01-09 02:17 UTC）

## 1. 背景与上下文

- 考勤的现实是“持续纠错 + 追溯重算”：补打卡、撤销、申诉、排班/日历/规则调整都会改变历史结果；系统必须能重算且可追溯，否则无法对账与合规解释。
- 本计划把“纠错”收敛为事件化写入（One Door）+ 同事务重算投射 + 可见审计链路，避免通过 UPDATE/手工脚本修表形成第二写入口。

## 2. 目标与非目标

### 2.1 目标（Done 的定义）

- [ ] **更正写入口事件化**：补卡/撤销/更正等动作统一走 `submit_*_event(...)`，并明确受影响重算边界（以 `work_date` 为主，必要时包含相邻日）。
- [ ] **读模可追溯**：同一 `work_date` 的最终结果可被重算覆盖，但事件序列可追溯；UI 可展示该日事件链与最后计算时间。
- [ ] **额度联动**：更正触发日结果重算时，余额/累加器（`DEV-PLAN-054`）同步回滚并重算。
- [ ] **UI 可操作**：在日结果页发起一次更正并触发重算（至少一条端到端链路）作为验收入口。

### 2.2 非目标（本计划不做）

- 不实现复杂审批流与多角色签核；先实现“可纠错、可追溯、可对账”的技术底座。
- 不做外部平台回写/对账回执（如需需另立计划）。

## 3. 关键设计决策（草案）

- **不更新 SoT**：不通过更新 `time_punch_events` 或日结果表来“打标/修正”；更正以新事件表达意图，再通过同步投射产生新读模。
- **bounded replay**：重算范围必须可界定（默认按 `work_date` + 邻接日）；避免全量重放历史造成不可接受的同步开销。
- **审计视图**：审计链路优先基于事件表与读模版本字段组合展示，不引入独立审计系统（早期避免过度运维）。

## 4. 数据模型（草案；落地迁移前需手工确认）

> 红线：新增数据库表/迁移落地前必须获得你手工确认。

- 候选事件类型（示意，最终需在 Kernel 中枚举化并可测试）：
  - `PUNCH_CREATED`（补打卡）
  - `PUNCH_VOIDED`（撤销/作废某条打卡）
  - `DAY_RESULT_ADJUSTED`（可选：直接对某日结果做调整事件；需谨慎，避免绕过规则）
- 备注：若需要“撤销某条 punch”，应避免 UPDATE/DELETE SoT；可通过“引用 event_id 的 void 事件”表达。

## 5. 工具链与门禁（SSOT 引用）

### 5.1 触发器（勾选本计划命中的项）

- [ ] Go 代码
- [ ] DB 迁移 / Schema（Atlas+Goose）
- [ ] sqlc
- [ ] 路由治理（Routing）
- [ ] Authz（Casbin）
- [ ] `.templ` / Tailwind（UI 资源）

### 5.2 SSOT 链接

- 触发器矩阵：`AGENTS.md`
- CI 门禁：`docs/dev-plans/012-ci-quality-gates.md`
- RLS：`docs/dev-plans/021-pg-rls-for-org-position-job-catalog.md`
- 路由：`docs/dev-plans/017-routing-strategy.md`
- Authz：`docs/dev-plans/022-authz-casbin-toolchain.md`
- 迁移闭环：`docs/dev-plans/024-atlas-goose-closed-loop-guide.md`
- sqlc：`docs/dev-plans/025-sqlc-guidelines.md`
- 上游切片：`docs/dev-plans/054-attendance-slice-4d-time-banking-and-accumulators.md`
- 蓝图：`docs/dev-plans/050-hrms-attendance-blueprint.md`

## 6. 实施步骤

1. [ ] 明确可支持的更正动作集合与最小 UI 入口（补卡/撤销/更正），并评审。
2. [ ] 设计更正事件的数据模型与约束；落迁移前获得手工确认。
3. [ ] Kernel：实现更正事件的写入口与同步重算投射（受影响 `work_date` + 邻接日），并联动重算余额/累加器。
4. [ ] sqlc：新增“按日查看事件链/按日查看最终结果”的查询。
5. [ ] UI：日结果详情页展示事件链与最后计算时间；提供更正入口并触发重算。
6. [ ] 测试：覆盖补卡、撤销、跨天影响、余额回滚重算；包含 RLS/Authz 负例。
7. [ ] 运行门禁并记录结果（必要时补 `docs/dev-records/`）。

## 7. 验收标准

- [ ] 用户可操作：能在 UI 发起一次更正并看到结果重算。
- [ ] 可追溯：同一天的事件链可视化，且最终结果与最后计算时间可解释。
- [ ] 一致性：日结果与余额/累加器同步更新（事务提交后即一致）。
- [ ] 安全与门禁：RLS/Authz/路由/生成物门禁全绿。

## 8. 开放问题

- [ ] `DAY_RESULT_ADJUSTED` 是否允许：若允许，需要如何避免绕过规则导致权威表达分裂。
- [ ] 撤销/作废事件的引用方式（引用 event_id vs. 引用自然键）与索引策略。

