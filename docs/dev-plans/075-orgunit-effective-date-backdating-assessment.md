# DEV-PLAN-075：OrgUnit 生效日期不允许回溯的限制评估

**状态**: 规划中（2026-02-05 23:31 UTC）

## 背景与问题
- 用户尝试将 OrgUnit（示例：Root Unit A / `ROOT260205A`）的生效日期改为 `2026-01-01`，系统报错。
- 当前 UI 的“更正（correction）”能力只允许将生效日期向后调整，且必须小于下一条记录的生效日期；不允许回溯至更早日期。

## 目标
- 记录问题与现状约束，明确为什么会报错。
- 评估是否需要支持“更早生效”（backdating）并给出变更范围。

## 现状与约束（当前行为，SSOT）
- 以下规则用于解释当前报错与限制；目标规则见“实施步骤（已选：支持更早生效）”。
- **更正（correction）规则**：生效日期只能向后更正，不允许比目标记录更早；且不得与下一条记录冲突。
- **插入记录（insert_record）规则**：只允许在现有最早与最晚记录之间插入，不能早于最早记录。
- 违反以上规则时，会出现 `EFFECTIVE_DATE_OUT_OF_RANGE` / `EVENT_DATE_CONFLICT` 等错误。

## 影响与问题表现
- 当用户输入 `2026.1.1`（非 `YYYY-MM-DD` 格式）会触发 `EFFECTIVE_DATE_INVALID`。
- 当用户尝试将现有记录更正为更早日期，会触发 `EFFECTIVE_DATE_OUT_OF_RANGE`。
- 若目标日期已存在记录，会触发 `EVENT_DATE_CONFLICT`。

## 规则梳理（用户视角，含完整示例）
### 示例数据（假设）
OrgUnit：`ROOT260205A`，已有记录：
- 2026-01-10：CREATE
- 2026-02-01：RENAME
- 2026-03-01：MOVE

### 总体原则（适用于更正/插入/新增）
- 记录日期不得与已有记录冲突。
- 生效日期不得超出“所处记录的期间范围”。
- 生效日期不得早于上级组织最早生效日期，且该日期上级组织必须处于有效状态。
- 日期格式必须为 `YYYY-MM-DD`。

### 1) 更正（correction）回溯/调整
**术语**：目标记录日期 = 被更正那条记录的生效日期（target_effective_date）。

**规则**：只能把日期调整到该记录“期间范围”内（不跨越相邻记录），并满足上级组织有效性约束。

**A. 更正 2026-02-01（中间记录）**
- 允许范围：**2026-01-11 ~ 2026-02-28**
  - 允许：2026-01-11、2026-02-01、2026-02-28
  - 不允许：2026-01-10（冲突上一条）、2026-03-01（冲突下一条）、2026-01-01（超范围）

**B. 更正 2026-01-10（最早记录）**
- 允许范围：**≤ 2026-01-31**（不与已有记录冲突）
  - 允许：2025-12-31、2026-01-10、2026-01-31
  - 不允许：2026-02-01（冲突下一条）、2026-02-05（超范围）

**C. 更正 2026-03-01（最晚记录）**
- 允许范围：**≥ 2026-02-02**（不与已有记录冲突）
  - 允许：2026-02-02、2026-03-01、2026-04-01
  - 不允许：2026-02-01（冲突上一条）、2026-01-31（超范围）

### 2) 插入记录（insert_record）
**规则**：插入时默认带出“所选记录”的数据；默认生效日期 = 选中记录日期 + 1；新日期必须落在“所选记录的期间范围”内，且满足上级组织有效性约束。

**A. 选择 2026-01-10（最早记录）**
- 允许范围：**≤ 2026-01-31**（不与已有记录冲突）
  - 允许：2025-12-15、2026-01-05、2026-01-31
  - 默认：2026-01-11（允许）
  - 不允许：2026-02-01（冲突下一条）、2026-02-10（超范围）

**B. 选择 2026-02-01（中间记录）**
- 允许范围：**2026-01-11 ~ 2026-02-28**（可向前或向后插入，只要介于前后记录之间）
  - 允许：2026-01-20、2026-02-02、2026-02-15、2026-02-28
  - 默认：2026-02-02（允许）
  - 不允许：2026-02-01（与本记录冲突）、2026-03-01（冲突下一条）、2026-01-10（冲突上一条）

**C. 选择 2026-03-01（最晚记录）**
- 将“插入”视同“新增”，允许 **≥ 2026-03-02**（默认 2026-03-02）。

### 3) 新增记录（add_record）
**规则**：只能在最晚记录之后。
- 最晚=2026-03-01
  - 允许：2026-03-02、2026-04-01
  - 不允许：2026-03-01（冲突）、2026-02-15（早于最晚）

### 4) 上级组织有效性约束（例子）
若上级组织最早生效日为 2026-01-15，则：
- 即使“期间范围允许 2026-01-11”，也应拒绝；
- 只有 **≥ 2026-01-15** 且上级组织在该日期有效才允许。

### 5) UI 文案（建议）
**通用提示**
- 日期格式：`请输入 YYYY-MM-DD 格式的日期`
- 日期冲突：`该日期已存在记录，请选择其它日期`
- 上级组织无效：`所选日期上级组织未生效或已失效，请调整日期`

**更正（correction）**
- 范围提示：`更正仅允许在 {min} ~ {max} 之间`
- 错误提示：`更正日期超出范围（{min} ~ {max}）`

**插入记录（insert_record）**
- 说明文案：`插入记录默认继承所选记录数据；默认日期为 {selected_date}+1`
- 范围提示：`插入日期需介于 {min} 与 {max} 之间（可早于所选记录）`
- 最晚记录提示：`若所选记录为最后一条，插入将视同新增，日期需晚于 {max}`

**新增记录（add_record）**
- 提示文案：`新增记录日期需晚于 {max}`
- 默认提示：`默认日期为 {max}+1`

## 评估方向（已确认）
**结论**：选择 **支持更早生效**。

1. **保持现状**：明确“更正”仅允许向后调整；更早生效需新增记录并调整业务流程。
2. **支持更早生效（已选）**：需要契约变更与校验规则重写，可能影响：
  - 事件序列稳定性（版本排序/有效期边界）
  - 读路径（as_of 解析结果变化）
  - UI 行为与提示语
  - 迁移/回放一致性与审计语义

## 实施步骤（已选：支持更早生效）
1. [x] 业务确认：必须支持“更早生效”，但采用**受控回溯**：
   - 新日期必须落在原区间（前后相邻记录之间；缺失一侧边界视为单侧无界）。
   - 不得跨越已有记录（不能越过上一条或下一条）。
   - 不得与已有记录同日冲突。
   - 上级组织在该日期必须有效，且不得早于上级最早生效日。
   - 最晚记录的 insert_record 视同 add_record（必须晚于最晚记录）。
2. [x] 契约更新：已同步修订 `DEV-PLAN-073`，并对齐 `DEV-PLAN-032` 的通用口径；`DEV-PLAN-031` 仅涉及 Valid Time 口径，无新增回溯细则（仅引用 SSOT，不复制门禁矩阵）。
3. [x] 规则调整（更正/插入逻辑与校验）
   - [x] 采用“更正叠加视图 + 事件追加”的写入方式（对齐 `DEV-PLAN-073`），不直接 UPDATE 事件表；更正后统一触发重放。
   - [x] 更新更正（correction）日期校验：允许区间内向前/向后调整；禁止跨越相邻记录；同日冲突拒绝。
   - [x] 更新 insert_record 校验：允许落在前后记录之间（可早于所选记录）；最晚记录插入视同新增。
   - [x] 加入上级组织有效性校验：新日期不得早于上级最早生效日，且上级在该日期必须有效。
   - [x] 确保改生效日触发重放，并按更正后 `effective_date` 重新排序（读模型一致性）。
4. [x] UI/错误提示（明确范围与原因）
   - [x] 表单默认值：insert 默认 `{selected_date}+1`；add 默认 `{max}+1`；最晚记录插入提示“视同新增”。
   - [x] 范围提示：展示 `{min} ~ {max}`，并说明“可早于所选记录”。
   - [x] 错误回显：区间超限/同日冲突/上级无效分别给出可操作提示。
5. [ ] 验收与记录
   - [x] 单测覆盖：中间记录前/后调整成功与越界失败；最早/最晚记录边界；上级无效拒绝；同日冲突；insert_record 最晚=add。
   - [x] 集成验证：改生效日后重放一致，`as_of` 结果与新日期一致。
   - [x] 记录证据：在 `docs/dev-records/` 写入门禁与关键路径结果。

## 交付物
- 评估结论与决策记录（已选：支持更早生效）。
- 契约文档更新与实现计划。

## 关联文档
- `AGENTS.md`
- `docs/dev-plans/073-orgunit-crud-implementation-status.md`
- `docs/dev-plans/032-effective-date-day-granularity.md`
- `docs/dev-plans/031-greenfield-assignment-job-data.md`
