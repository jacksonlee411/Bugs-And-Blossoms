# DEV-PLAN-004：全仓去除版本标记（命名降噪 + 避免对外契约污染）

**状态**: 草拟中（2026-01-06 09:25 UTC）

> 目标：在项目早期、仓库只有一套实现的前提下，**彻底清除“版本标记”**带来的噪音与命名膨胀，并避免用户侧形成不必要的对外契约（UI 文案/URL/路由/包名/文件名等）。
>
> 说明：本文是“全仓重命名/去噪”的实施计划；不引入新业务功能、不替代任何业务 dev-plan 合同。若重命名过程中发现需要改变外部行为或新增契约，必须先回到对应 dev-plan 更新合同再实施。

## 0.1 评审口径（冻结）

- 本计划的评审与验收口径为：**彻底全仓清理**——包含 `docs/dev-plans/**` 在内的所有文件名与正文内容；仓库内不再出现版本标记字面量。
- 由于本仓库的技术栈依赖可能包含语义版本段（例如 Go module major version 的 `/vN`），本计划的“版本标记”只覆盖本文定义的目标集合（见 1.1）；不试图清除第三方依赖的版本表达。

## 0. 进度速记

1. [X] 创建 `DEV-PLAN-004` 并加入 Doc Map（2026-01-06 15:50 UTC，本 PR）。
2. [X] 盘点全仓版本标记出现点（2026-01-06 09:25 UTC）—— 见 `docs/dev-records/dev-plan-004-version-marker-removal-mapping.md`。
3. [ ] 输出“旧名 → 新名”映射表并冻结（避免 PR 间反复改名）—— 已有草案；需先定稿 `read=` 新值与锁 key 前缀后冻结。
4. [ ] 分批 PR 完成重命名，并确保门禁全绿且不 `skipped`。
5. [ ] 加入防回归门禁：禁止版本标记再次进入仓库（包含文档与代码）。

## 1. 背景

本仓库为 Greenfield 全新实施，目标是保持“唯一实现”的语义清晰：
- 命名中反复出现版本标记会造成噪音、认知负担与命名膨胀。
- 将版本标记暴露到 UI/URL 会让用户误解“存在多版本可选”，并形成不必要的对外契约（未来难以收回）。
- 早期阶段更适合一次性收敛命名，而不是等到功能堆积后再做大规模迁移。

## 1.1 术语与定义（SSOT）

- **版本标记（本计划范围内）**：由字符 `v`/`V` 与数字 `4` 组成的标记（例如 `v`+`4` 或 `V`+`4`），以及其在命名中的常见承载形态：
  - 文件名/目录名：`*-<ver>-*`、`*_<ver>_*`、`*<ver>*`（其中 `<ver>` 表示 `v`+`4` 或 `V`+`4`；仅当可解释为“版本标记”，而非第三方依赖的版本路径）。
  - 路由与 URL：path segment、query param value、重定向 Location 等出现的 `<ver>`。
  - 代码与 SQL：包名/类型名/函数名、错误文案、锁 key、常量、测试断言里的 `<ver>`。
- **“彻底清理”验收口径**：仓库根目录下全量扫描命中数为 0（包含 `docs/dev-plans/**` 文件名与正文）；扫描模式为“`v` 紧邻 `4`”或“`V` 紧邻 `4`”。

## 2. 目标与非目标

### 2.1 目标（必须）

- [ ] 仓库内（代码 + 文档 + 资源 + 迁移 + 脚本）不再出现版本标记字面量（包含 `docs/dev-plans/**` 文件名与正文）。
- [ ] 所有用户可见面（导航/页面标题/错误提示/按钮/URL）不暴露版本标记。
- [ ] 所有开发者入口（文件名/包名/路由/脚本）不暴露版本标记。
- [ ] CI 与本地门禁增加防回归检查（确保后续 PR 不会再次引入版本标记）。

### 2.2 非目标（明确不做）

- 不引入新业务能力（例如新增实体/接口/迁移内容）。
- 不改变既有业务语义（除“名称/路径/展示文案/公开标识”本身的变化外）。
- 不提供长期兼容别名（含旧 URL 的长期保留）。若必须短期过渡，必须在本计划中明确时间盒与删除条件。

## 3. 影响范围（清单）

需要覆盖并一次性清理的范围包括：
- UI：导航文案、页面标题、占位页、提示与错误文案。
- 路由：所有包含版本标记的 path segment、页面链接与跳转目标。
- Go 代码：文件名、包名、类型/接口/函数命名、测试与示例。
- DB 与迁移：迁移文件名（若仓库约束允许）、`atlas.sum`、以及脚本/文档引用。
- 文档：dev-plan/records、Doc Map、文档内链接与引用。
- 脚本与门禁：Makefile 目标、CI 步骤、检查脚本。

## 4. 实施策略（强制约束）

### 4.0 约束：不可混跑（Cutover 语义）

本计划会触达以下高风险点：URL/query 参数与 SQL 锁 key。它们属于“对外契约/运行时语义承载”，不允许出现“旧/新版本同时运行但互不兼容”的窗口：
- [ ] 任何涉及路由/URL/Location 的改动，必须在同一 PR 内完成：服务端处理 + 前端/HTMX 链接 + 测试断言 + 文档/证据。
- [ ] 任何涉及互斥锁 key（或其他跨请求共享标识）的改动，必须在同一 PR 内完成：SQL/Go 生成 key 的所有路径 + 测试 +（如有）运维/脚本口径。

### 4.1 合同优先与 PR 纪律

- [ ] 每个 PR 在发起前，必须先更新“该 PR 对应的 dev-plan 文档”的勾选项与状态（对齐 `DEV-PLAN-009M1` 的规则）。
- [ ] 每个 PR 必须保持 required checks 全绿且不 `skipped` 后方可合并。

### 4.2 旧名 → 新名映射表（冻结）

- [ ] 在开工重命名前，先产出映射表（建议放在本计划附录或单独的 `docs/dev-records/` 记录中），列出：
  - 文件名/包名/路由/页面标题等的旧名与新名；
  - 是否属于对外契约（URL/UI），以及是否允许短期时间盒过渡。
- [ ] 映射表冻结后，后续 PR 不允许随意改动命名方向（避免漂移）。

**映射表最低字段（建议表格）**
- [ ] 类别：`docs-file` / `doc-title` / `route` / `url` / `go-id` / `sql-id` / `lock-key` / `ui-copy` / `script`。
- [ ] 旧名：包含版本标记的原始字面量与所在位置（文件路径 + 片段）。
- [ ] 新名：明确替换后的最终权威表达（不再含版本标记）。
- [ ] 对外契约：`yes/no`（URL、用户可见文案、公开 API 视为 `yes`）。
- [ ] 风险等级：`high/medium/low`（锁 key、URL、迁移/atlas 相关默认 `high`）。
- [ ] 验收方式：如何证明该点“仅改名不改语义”（测试/门禁/手工步骤）。

### 4.3 防回归门禁（必须）

- [ ] 增加一个“命名去噪”检查：在 CI 与本地门禁中扫描仓库，发现版本标记即失败。
- [ ] 实现该检查时，不应把版本标记字面量硬编码到脚本文件中；建议用字符串拼接构造搜索模式（例如 `prefix="v"; digit="4"`），避免检查脚本本身成为引入源。

## 5. 实施步骤（建议 PR 序列）

> 备注：以下为“建议拆分”；可按实际依赖合并/拆分，但必须保持单 PR 变更可审、变更可控、可验证。

### PR-1：盘点与映射表冻结

- [X] 全仓扫描版本标记出现点并分类（2026-01-06 09:25 UTC）。
- [ ] 输出并冻结映射表（旧名 → 新名）—— 已有草案；待定稿后冻结（见 `docs/dev-records/dev-plan-004-version-marker-removal-mapping.md`）。
- [ ] 明确是否存在必须时间盒过渡的对外契约；如有，写清删除条件与最晚删除时间。

### PR-2：文档与 Doc Map 清理

- [ ] 统一调整 dev-plan/records 的标题与正文表述，去除版本标记字面量。
- [X] **重命名所有含版本标记的 dev-plan 文件名**，并同步更新 `AGENTS.md` Doc Map 与全仓所有引用链接（文档/代码/脚本/测试）（2026-01-06 09:49 UTC）。
- [X] 运行文档门禁并确保 `make check doc` 通过（2026-01-06 09:49 UTC）。

### PR-3：路由与 UI 文案清理

- [ ] 调整所有含版本标记的路由与页面链接，确保用户侧 URL/页面不暴露版本标记。
- [ ] 更新 routing allowlist 与 routing gates，确保 `make check routing` 通过。
- [ ] 更新 readiness 证据中的链接与步骤（固化到 `docs/dev-records/`）。

### PR-4：Go 代码命名清理

- [ ] 重命名 Go 文件/包/类型/函数，保持语义不变并更新所有引用。
- [ ] 按 `AGENTS.md` 触发器矩阵运行对应门禁，并确保生成物与工作区状态符合要求（必要时使用 `make preflight` 一键对齐 CI）。

### PR-5：迁移与工具链清理（高风险，需小步）

- [ ] 若需要重命名迁移文件：先在对应模块 dev-plan 中明确“迁移文件名是否允许变更”的约束与验证方式，再实施。
- [ ] 从零环境验证：能从空数据库完整执行迁移闭环（按模块入口）。

### PR-6：防回归门禁落地

- [ ] 将“命名去噪”检查接入 CI 与本地入口（建议挂在 `make check` 或 `make preflight` 的合适阶段）。
- [ ] 明确排除策略（原则：默认不排除；若必须排除，必须写明原因与审计方式）。

## 6. 验证与证据（执行期必须记录）

- [ ] 本地：按触发器矩阵运行对应门禁（见 `AGENTS.md`），并记录关键命令与结果时间戳。
- [ ] CI：required checks 全绿且不 `skipped`。
- [ ] 证据：将“新版 URL/页面入口/验证步骤”固化到 `docs/dev-records/`（作为可复现入口）。

## 7. 验收标准（Stopline）

- [ ] 全仓扫描命中数为 0（包含 `docs/dev-plans/**` 文件名与正文）；扫描模式为“`v` 紧邻 `4`”或“`V` 紧邻 `4`”。
- [ ] required checks 全绿且不 `skipped`。
- [ ] 任何对外契约变更（URL/UI 文案/公开命名）均已在对应 dev-plan 或 `docs/dev-records/` 中固化验证入口与证据。
