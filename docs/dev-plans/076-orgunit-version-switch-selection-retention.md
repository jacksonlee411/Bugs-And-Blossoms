# DEV-PLAN-076：OrgUnit 版本切换导致选中组织丢失问题与修复方案

**状态**: 方案B已确定，待实施（2026-02-06）

## 背景与问题
- 现象：在 `/org/nodes?as_of=2026-01-03`，点击“财务部2”后，点击“上一条/下一条”，页面刷新并回到根节点（如“飞虫与鲜花”）的详情，导致选中组织丢失。
- 该问题在 Local Tenant（`localhost`）复现，且与 UI 使用全局 `as_of` 刷新机制强相关。

## 影响
- 用户误以为切换的是当前组织的版本，但实际切到根节点，造成“当前组织丢焦”与误操作风险。
- 与“版本切换后编辑区随之更新”的验收口径不一致。

## 根因分析（初步）
- 版本切换按钮使用 `window.location.href = "/org/nodes?as_of=..."` 进行全页刷新。
- 页面初始化依赖 `localStorage` 的 `org_nodes_last_org_code` 进行选中恢复，但在刷新后未稳定恢复目标组织（尤其是根节点优先渲染时）。

## 修复方案（已确定：方案 B）
- 取消全局 `as_of` 机制：页面顶部标题栏与 OrgUnit Details 顶部不再展示有效日期。
- 左侧 Nodes Panel 新增“生效日期”控件，仅用于控制组织树加载的时间点。
- 版本切换（上一条/下一条/下拉）改为局部刷新详情区，不触发全页跳转，树选中保持不变。
- 详情区版本列表的切换与展示不再依赖“全局 as_of”。

## 实施步骤
1. [ ] 移除全局 `as_of` 相关 UI 与状态（顶部标题栏、OrgUnit Details 顶部）。
2. [ ] 在 Nodes Panel 增加“生效日期”输入，用于组织树查询参数（仅影响树）。
3. [ ] 版本切换改为局部刷新详情区，保持树选中与面包屑不变。
4. [ ] 更新版本选择器状态同步逻辑。
5. [ ] 补充自动化验证（E2E/单测）覆盖“切换后仍保持当前组织”。
6. [ ] 更新验收记录与执行日志。

## 验收标准
- 点击“上一条/下一条/下拉切换”后，**当前组织不丢焦**，详情区保持为同一组织的不同版本。
- 页面顶部与 OrgUnit Details 顶部不再展示全局有效日期。
- 左侧“生效日期”仅影响组织树，不影响详情区的版本切换。

## 关联文档
- `AGENTS.md`
- `docs/dev-plans/074-orgunit-details-update-ui-optimization.md`
- `docs/dev-plans/073-orgunit-crud-implementation-status.md`
