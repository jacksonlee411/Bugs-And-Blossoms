# DEV-PLAN-076：OrgUnit 版本切换导致选中组织丢失问题与修复方案

**状态**: 规划中（2026-02-06 02:12 UTC）

## 背景与问题
- 现象：在 `/org/nodes?as_of=2026-01-03`，点击“财务部2”后，点击“上一条/下一条”，页面刷新并回到根节点（如“飞虫与鲜花”）的详情，导致选中组织丢失。
- 该问题在 Local Tenant（`localhost`）复现，且与 UI 使用全局 `as_of` 刷新机制强相关。

## 影响
- 用户误以为切换的是当前组织的版本，但实际切到根节点，造成“当前组织丢焦”与误操作风险。
- 与“版本切换后编辑区随之更新”的验收口径不一致。

## 根因分析（初步）
- 版本切换按钮使用 `window.location.href = "/org/nodes?as_of=..."` 进行全页刷新。
- 页面初始化依赖 `localStorage` 的 `org_nodes_last_org_code` 进行选中恢复，但在刷新后未稳定恢复目标组织（尤其是根节点优先渲染时）。

## 修复方案（建议）
### 方案 A：携带 org_code 并优先恢复（推荐）
- 在版本切换时，将当前组织 `org_code` 一并写入 URL（如 `?as_of=...&org_code=...`）。
- 页面初始化优先读取 `org_code` 参数进行选中恢复；仅在缺失时回退到 `localStorage`。
- 优点：改动小、与现有全页刷新机制兼容。

### 方案 B：局部刷新，不走全页跳转
- 版本切换改为调用 `loadDetails(org_id, { asOf })` 并更新版本列表。
- 仅局部刷新详情区，保持树选中不变。
- 优点：用户体验更好；缺点：需要更细的状态同步。

## 实施步骤
1. [ ] 确认采用方案（A/B 或组合）。
2. [ ] 若采用方案 A：补充 URL 参数解析与恢复逻辑（优先 `org_code`）。
3. [ ] 若采用方案 B：版本切换改为局部更新，并同步版本选择器状态。
4. [ ] 补充自动化验证（E2E/单测）覆盖“切换后仍保持当前组织”。
5. [ ] 更新验收记录与执行日志。

## 验收标准
- 点击“上一条/下一条/下拉切换”后，**当前组织不丢焦**，详情区保持为同一组织的不同版本。
- 版本切换后，URL `as_of` 与详情展示一致（若采用方案 A）。

## 关联文档
- `AGENTS.md`
- `docs/dev-plans/074-orgunit-details-update-ui-optimization.md`
- `docs/dev-plans/073-orgunit-crud-implementation-status.md`
