# DEV-PLAN-044：Payroll P0-4——个税累计预扣法（IIT）与 YTD Balances

**状态**: 规划中（2026-01-08 02:40 UTC）

> 上游路线图：`DEV-PLAN-039`  
> 依赖：`DEV-PLAN-041/042/043`（主流程 + 应发 + 社保扣缴）  
> 蓝图合同：`DEV-PLAN-040`

## 0. 可执行方案（本计划合同）

### 0.1 背景与上下文

累计预扣法依赖历史累计值。为避免“月数越多越慢”的线性聚合，本切片必须落地 `payroll_balances`（或等价累加器表）实现 O(1) 获取累计收入/已纳税等基础数据，并把个税结果写入工资条明细与汇总。

### 0.2 目标与非目标（P0-4 Slice）

**目标**
- [ ] 冻结个税累计预扣法的输入口径：累计收入/累计免税/累计减除费用/专项扣除（含社保个人部分）/专项附加扣除/累计已预扣税额。
- [ ] 落地 `payroll_balances`（增量表/累加器）并通过事务一致性更新（同一 payroll run 定稿时写入）。
- [ ] 实现累计预扣算法（含负数留抵逻辑），并把本期应预扣税额写入工资条明细（IIT）。
- [ ] 工资条汇总 `net_pay` 可由明细重算，且与个税计算一致。

**非目标**
- 不实现年度汇算清缴全流程与外部申报对接（后续里程碑）。

### 0.3 工具链与门禁（SSOT 引用）

- 金额精度与舍入合同：`DEV-PLAN-040` §4.2
- DB/迁移闭环：`docs/dev-plans/024-atlas-goose-closed-loop-guide.md`
- sqlc：`docs/dev-plans/025-sqlc-guidelines.md`

### 0.4 关键不变量与失败路径（停止线）

- **O(1) 读取历史**：禁止在热路径用 `SELECT SUM(...) FROM payroll_results WHERE year=...` 线性回看。
- **负数处理**：当月应预扣税额为负时，必须存为“留抵税额/税额抵扣余额”，并在后续月份自动抵扣（不得直接退税）。
- **事务一致性**：balances 更新必须与 payroll run 定稿在同一事务内完成，避免“工资条已定稿但 balances 未更新”的双权威。

### 0.5 实施步骤（Checklist）

1. [ ] 冻结税基口径：哪些 pay items 计入“累计收入”，哪些计入“专项扣除/附加扣除”（P0 可先最小集合，但必须写清）。
2. [ ] 设计 `payroll_balances`：按 `tenant_id/person_id/tax_year`（或等价键）存储累计值与留抵税额。
3. [ ] 计算引擎：实现累计预扣法（税率表/速算扣除数可先固化为表或常量，但需可替换）。
4. [ ] 写入工资条：新增 IIT 明细项（本期应预扣税额），并更新 `net_pay`。
5. [ ] 测试：覆盖负数留抵、跨月累计、社保扣除影响税基。

### 0.6 验收标准（Done 口径）

- [ ] 运行两个月 pay period：第 2 个月个税计算不依赖聚合扫描历史工资条，且结果受第 1 个月累计影响（可测）。
- [ ] 出现“应预扣税额为负”的输入时，当月 IIT=0 且留抵金额被正确保存并影响下月。
- [ ] 工资条展示 IIT 明细项，`net_pay` 与明细聚合一致。

## 1. 备注（与后续切片的边界）

`DEV-PLAN-046` 的税后发放（仅个税）会复用本切片的 IIT 引擎作为 `ΔIIT(x)` 的计算基准；`DEV-PLAN-045` 的回溯结转会复用本切片的 balances 口径，确保差额进入后续周期时累计口径一致。
