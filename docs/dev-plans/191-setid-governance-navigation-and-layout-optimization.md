# DEV-PLAN-191：/app/org/setid 导航与页面设计优化方案（一级/二级菜单 + 独立滚动 + DEV-PLAN-002 对齐）

**状态**: 实施中（2026-02-26 10:40 UTC，M1/M2/M3/M4/M6 已完成，M5 持续收口）

## 1. 背景与问题
当前 `/app/org/setid` 已具备能力配置功能，但在导航可发现性与页面信息架构上存在明显认知负担，且有可用性缺陷（capability_key 表格横向滚动落到全局页面）。本计划用于承接以下用户关注点：

1. 一级菜单更名建议；
2. 增加二级菜单，并明确命名与布局；
3. capability_key 表格应使用独立滚动条，不应触发全局页面横向滚动；
4. 收敛不符合 `DEV-PLAN-002` 的 UI 设计问题。

术语口径（本方案冻结）：`SetID` 的中文展示统一为 **`集合ID`**。

## 2. 现状评估（As-Is）

### 2.1 一级菜单语义偏技术化
- 当前导航项名称：`集合ID 管理`（`apps/web/src/i18n/messages.ts` 的 `nav_setid`）。
- 问题：名称偏“技术对象”，不利于业务用户快速理解“这是配置与策略中心”。

### 2.2 二级信息架构拥挤
- 当前页面以四个页签承载：`Registry / Explain / Functional Area / Activation`。
- `Registry` 同时承载「集合ID 建立/绑定」「策略列表」「策略编辑」，单页信息密度过高，主任务路径不清晰。
- 二级任务入口未进入最左侧导航，导致“模块内切换”与“全局切换”交互位置不一致。

### 2.3 capability_key 表格横向滚动体验不正确
- 表格列较多（`strategyColumns` 累计最小宽度明显超出常见视口）。
- 当前表现为全局页面出现横向滚动，影响整体导航与阅读。
- 目标应为：仅策略表格区域出现横向滚动条（局部滚动容器）。

### 2.4 与 DEV-PLAN-002 的不一致项
- 页面内大量硬编码英文文案/技术字段名，i18n 与可读性不足。
- 同页混用 MUI DataGrid 与原生 `<table>` + 内联样式（`#fff/#eee`），一致性不足。
- 列表/操作区主次层级不稳定（多个区域同时强调主按钮），任务焦点分散。

### 2.5 现状边界图（文字）
- 导航层：`AppShell(navItems)` -> 左侧一级菜单项 `/app/org/setid`。
- 页面层：`SetIDGovernancePage`（单页承载多任务域，当前由 `tab` 参数切换）。
- 组件层：策略列表走 `DataGridPage`，其余列表仍有原生 `<table>`。
- 契约层：路由保持 `/app/org/setid`，后端 API 仍为 `/org/api/*`，本计划仅改导航与前端 IA，不改写入语义。

## 3. 目标
- [x] 一级菜单命名从“技术对象导向”调整为“业务任务导向”。
- [x] 建立清晰二级菜单，并落在**最左侧导航栏**，将“基础配置”与“配置策略”拆分，降低单页复杂度。
- [x] capability_key 表格滚动收敛为局部独立滚动，不再出现全局横向滚动条。
- [ ] 对齐 `DEV-PLAN-002`：组件一致性、i18n、一致的按钮层级与反馈状态（本次已完成导航分层与滚动修复，剩余项后续收口）。

## 3A. 非目标（边界冻结）
- 不新增/修改后端 API、数据库结构、权限模型与 capability 判定语义。
- 不新增第二套页面入口或并行旧 UI（保持 `/app/org/setid` 单入口）。
- 不引入长期兼容别名窗口；仅允许旧参数/旧路径的短期兼容，且必须有退场条件。
- 不改动 `request_id/trace_id`、`as_of/effective_date` 等跨仓标准语义。

## 4. 优化方案（To-Be）

### 4.1 一级菜单更名建议（冻结建议）
- **建议名称（zh）**：`配置与策略`
- **建议名称（en）**：`Configuration & Policy`
- **替换关系**：`nav_setid`（集合ID 管理）→ `nav_configuration_policy`（配置与策略）
- **理由**：用户心智从“集合ID 对象维护”转向“策略配置、解释、开关、激活”的业务任务闭环。

### 4.2 二级菜单新增与命名、布局（最左侧导航栏）
重评分层后，左侧二级菜单不直接等于当前所有 Tab；采用“模块入口（左侧）+ 局部任务（页面内）”两层：

左侧二级菜单（建议 4 项）：
1. `集合ID与绑定`（SetID & Bindings）
2. `策略规则`（Policy Registry）
3. `命中解释`（Explain）
4. `策略运维`（Policy Ops）

页面内菜单（属于各二级页面）：
- `集合ID与绑定` 页面内：`集合ID 列表` / `绑定关系`
- `策略规则` 页面内：`规则列表` / `规则编辑`
- `策略运维` 页面内：`功能域开关` / `版本激活`
- `命中解释` 页面内：默认单页（无需再拆）

布局建议：
- 左侧导航采用“一级 + 缩进二级”结构：点击一级“配置与策略”可展开/折叠二级菜单。
- 左侧二级菜单使用独立路由，建议：
  - `/app/org/setid/base`
  - `/app/org/setid/registry`
  - `/app/org/setid/explain`
  - `/app/org/setid/ops`
- 页面内菜单用 Tabs/Segmented Control 表达局部任务，避免把局部状态提升为左侧全局项。

### 4.3 capability_key 表格独立滚动修复
实施口径：
- 在壳层主内容容器增加 `minWidth: 0`，避免子内容撑破主布局。
- 在策略表格容器建立局部横向滚动上下文（`overflowX: auto`），并限制滚动影响范围。
- 保持 DataGrid 自身虚拟滚动能力，不以全局页面滚动替代表格滚动。

验收口径：
- 页面主体不出现全局横向滚动条；
- 仅 capability 策略表格区域出现横向滚动条；
- 表格横向滚动时左侧导航与顶部结构不抖动。

### 4.4 其他 DEV-PLAN-002 对齐项
1. 文案/i18n 对齐：页面标题、Tab 名称、按钮文案、错误提示迁移到 i18n 词条，去除硬编码英文。
2. 组件一致性：将原生 `<table>` 区块统一为 MUI DataGrid（或 MUI Table + 统一样式 token），禁止分散内联样式。
3. 按钮层级：每个任务域仅保留 1 个主操作（contained primary），其余动作降级为 outlined/text。
4. 状态反馈：统一空态/加载态/错误态文案与展示位置，避免同页多处重复提示抢焦点。

### 4.5 契约冻结（实现必须遵守）
- 路由契约：页面入口仍为 `/app/org/setid`，并收敛为左侧二级路由（`/app/org/setid/*`），不新增并行入口。
- 参数契约：二级菜单以 path segment 表达，不再以 `tab/section` 作为长期主契约。
- 兼容契约：旧 `tab` 参数仅用于短期跳转映射到新子路由，兼容窗口结束后移除。
- 分层契约：左侧二级菜单仅承载“可独立直达的子页面”；页面内菜单仅承载当前子页面的局部任务视图。
- 权限契约：保持现有 `permissionKey` 与写操作鉴权语义不变，本计划仅调整 IA 与展示。
- i18n 契约：新增文案必须进入 `apps/web/src/i18n/messages.ts`（`en/zh` 同步），禁止新硬编码。

## 5. 标准与门禁对齐（DEV-PLAN-003 / DEV-PLAN-005）

### 5.1 命中标准（STD-XXX）
- [x] `STD-005`（前端单链路与入口唯一性）：仅保留 `/app/org/setid` 入口，不新增第二入口。
- [x] `STD-004`（版本标记最小暴露）：对外命名采用业务语义“配置与策略”，不引入技术噪音命名。
- [x] `STD-002`（时间语义）：`as_of` 行为与 day 粒度上下文不改变，仅 UI 编排优化。

### 5.2 触发器与验证入口
- [x] 文档变更：`make check doc`
- [x] MUI Web UI 变更（`apps/web/**`）：`make generate && make css`，并执行 `git status --short`（生成后不得出现遗漏生成物）
- [x] 多语言 JSON 变更（`messages.ts`）：`make check tr`

### 5.3 证据形态（PR 必填）
- [x] 明确列出本次命中的触发器与 STD 条目。
- [x] 粘贴实际运行命令与结果（通过/失败重跑）。
- [ ] 若涉及旧 `tab` 参数兼容窗口，附“参数到子路由映射”退场执行记录与完成时间。

## 6. 实施步骤
1. [x] M1：冻结 IA、命名与路由契约（一级菜单 + 4 个左侧二级菜单 + 页面内菜单口径）。
2. [x] M2：导航改造（`navigation/config.tsx`、`AppShell.tsx`、`messages.ts`，落地左侧可展开二级导航）。
3. [x] M3：页面结构拆分（原单页多 Tab 拆分为“4 个二级页面 + 页面内局部菜单”）。
4. [x] M4：滚动修复（壳层与策略表格容器的局部滚动收敛）。
5. [ ] M5：`DEV-PLAN-002` 收口（i18n、表格组件一致性、按钮层级、状态反馈）。
6. [x] M6：门禁与证据收口（`make generate && make css`、`make check tr`、`make check doc`）。

## 7. 验收标准
- [x] 一级菜单完成更名，且中英文文案一致可见。
- [x] 二级菜单出现在最左侧导航栏，并可展开/折叠；用户可在 4 个二级页面间切换且 URL 可恢复。
- [x] `功能域开关/版本激活` 已收敛到“策略运维”页面内菜单，不再占用左侧独立二级菜单位。
- [x] capability_key 表格滚动为局部独立滚动，全局页面无横向滚动条。
- [ ] 页面符合 `DEV-PLAN-002`：统一组件体系、文案可读、操作层级清晰、状态反馈一致（本次部分完成）。
- [x] 二级菜单以子路由为唯一主契约；兼容期内旧 `tab` 参数仅做跳转映射。
- [x] PR 证据包含触发器命中、STD 对齐、命令结果与生成物 clean 结果。

## 8. 风险与缓解
- **风险 1：导航改名导致用户短期找不到入口**  
  缓解：上线初期在菜单副标题或页面内提示“原 集合ID 管理已升级为配置与策略”。

- **风险 2：二级菜单拆分引发历史深链失效**  
  缓解：保留旧 `tab` 参数兼容映射到新子路由，并在同一迭代内退场（最长 14 天）。
  - 触发条件：M3 上线后即进入退场倒计时。
  - 责任人：前端模块 owner（Org Web）。
  - 退场门槛：E2E 与手工验证均只使用子路由；文档/测试不再引用 `tab`。
  - 失败处置：若出现故障，仅允许修复参数映射或子路由默认值逻辑，不恢复长期双参数双写。

- **风险 3：滚动修复影响其他页面布局**  
  缓解：优先局部改造集合ID 页面；若需壳层调整，补充关键页面回归清单。

## 9. 失败处置与恢复（No-Legacy）
- 环境级保护：若发布后出现严重可用性问题，先将二级菜单默认落在“基础配置”并保持只读可查看。
- 修复策略：仅在当前单链路内修复（布局、参数解析、i18n、滚动容器），禁止引入旧页并行或 legacy 回退。
- 恢复判定：关键路径（进入页面、切换二级菜单、策略表格横向滚动）回归通过后恢复完整交互。

## 10. 关联文件（实施入口）
- `apps/web/src/navigation/config.tsx`
- `apps/web/src/i18n/messages.ts`
- `apps/web/src/layout/AppShell.tsx`
- `apps/web/src/pages/org/SetIDGovernancePage.tsx`
- `apps/web/src/components/DataGridPage.tsx`
- `docs/dev-plans/002-ui-design-guidelines.md`

## 11. 执行证据（2026-02-26）
- `make generate`：通过（no-op，占位门禁）
- `make css`：通过（`tsc -b && vite build` 成功，产物已更新）
- `make check tr`：通过（no-op，占位门禁）
- `make check doc`：通过
